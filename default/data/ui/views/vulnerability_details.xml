<form version="1.1" theme="dark" script="vuln_table_data_bar.js" stylesheet="vuln_table_data_bar.css">
  <label>Vulnerability Details</label>
  <description>This dashboard shows details around vulnerabilities detected in the environment by Greenbone Vulnerability Manager.</description>
  <fieldset submitButton="false" autoRun="true">
    <input type="time" token="timeToken" searchWhenChanged="true">
      <label>Time</label>
      <default>
        <earliest>-7d@h</earliest>
        <latest>now</latest>
      </default>
    </input>
    <input type="dropdown" token="tokAsset" searchWhenChanged="true">
      <label>Assets</label>
      <choice value="*">All</choice>
      <default>*</default>
      <initialValue>*</initialValue>
      <fieldForLabel>dest</fieldForLabel>
      <fieldForValue>dest</fieldForValue>
      <search>
        <query>`gvm_index` `gvm_sourcetype`
| stats count by dest</query>
        <earliest>-7d@h</earliest>
        <latest>now</latest>
      </search>
    </input>
  </fieldset>
  <row>
    <panel>
      <title>Results by Severity</title>
      <html>
        <style>
          .dashboard-row .dashboard-panel .panel-head h3 {
             border: 1px dashed #20689C;
             border-left: 6px solid #20689C;
             font-weight: normal;
          }
        </style>
      </html>
      <viz id="vizSeverity" type="semicircle_donut.semicircle_donut">
        <search>
          <query>`gvm_index` `gvm_sourcetype` dest=TERM($tokAsset$)
| eval key = dest_ip + 'result.nvt{@oid}' 
| stats dc(key) as count by severity
| eval severity_level = case(severity=="informational", 0, severity=="low", 1, severity=="medium", 2, severity=="high", 3, 1=1, -1)
| sort -severity_level
| fields - severity_level
`make_proper_case(severity)`
| eval color = case(severity=="High", "#D41F1F", severity=="Medium", "#DD9F54", severity=="Low", "#DCC160", true(), "#53963E")</query>
          <earliest>$timeToken.earliest$</earliest>
          <latest>$timeToken.latest$</latest>
          <sampleRatio>1</sampleRatio>
        </search>
        <option name="displayview">search</option>
        <option name="drilldown">all</option>
        <option name="height">350</option>
        <option name="refresh.display">progressbar</option>
        <option name="semicircle_donut.semicircle_donut.colorField">color</option>
        <option name="semicircle_donut.semicircle_donut.cutoutPercentage">50</option>
        <option name="semicircle_donut.semicircle_donut.legendPosition">top</option>
        <option name="semicircle_donut.semicircle_donut.type">half</option>
        <option name="trellis.enabled">0</option>
        <option name="trellis.scales.shared">1</option>
        <option name="trellis.size">medium</option>
      </viz>
    </panel>
    <panel>
      <title>Results by CVSS Score</title>
      <chart>
        <search>
          <query>`gvm_index` `gvm_sourcetype` dest=TERM($tokAsset$)
| eval key = dest_ip + 'result.nvt{@oid}' 
| stats dc(key) as count by cvss
| rangemap field=cvss Informational=0-1 1=1.0-1.9 2=2.0-2.9 3=3.0-3.9 4=4.0-4.9 5=5.0-5.9 6=6.0-6.9 7=7.0-7.9 8=8.0-8.9 9=9.0-9.9 10=10.0-10.0
| stats sum(count) as Vulnerabilities by range
| sort num(range)</query>
          <earliest>$timeToken.earliest$</earliest>
          <latest>$timeToken.latest$</latest>
        </search>
        <option name="charting.axisTitleX.text">CVSS Score</option>
        <option name="charting.chart">bar</option>
        <option name="charting.drilldown">none</option>
        <option name="charting.legend.placement">top</option>
        <option name="charting.seriesColors">[0xf90000]</option>
        <option name="height">350</option>
        <option name="refresh.display">progressbar</option>
      </chart>
    </panel>
  </row>
  <row>
    <panel>
      <title>Vulnerability Details</title>
      <input type="dropdown" token="tokType" searchWhenChanged="true">
        <label>Detection Type</label>
        <choice value="*">All</choice>
        <choice value="nvt">NVTs</choice>
        <choice value="cve">CVEs</choice>
        <default>*</default>
        <initialValue>*</initialValue>
      </input>
      <input type="text" token="tokVulnerability" searchWhenChanged="true">
        <label>Search Vulnerabilities</label>
        <default>*</default>
        <initialValue>*</initialValue>
      </input>
      <table id="tableVulnerabilities">
        <title>Note: You can expand any of the vulnerabilities to see more details about it.</title>
        <search>
          <query>`gvm_index` `gvm_sourcetype` dest=TERM($tokAsset$) "result.nvt.type"=$tokType$ signature=$tokVulnerability$
| eval key = dest_ip + 'result{@id}' 
| fillnull value="" result.nvt.solution{@type} 
| stats dc(key) as count values(result{@id}) as id values(location) as Location by _time, signature, category, result.nvt.solution{@type}, cvss, severity, result.qod.value, dest_ip, dest
| sort -cvss
| eval Severity = cvss + " (" + upper(substr(severity, 1, 1)) + substr(severity, 2) + ")"
| eval "Solution Type" = if(isnull('result.nvt.solution{@type}') OR cvss = 0, "N/A", 'result.nvt.solution{@type}')
| fields - count cvss severity
| rename _time as "Created" signature as Vulnerability category as Category  result.qod.value as "Detection Quality" dest_ip as IP dest as Name
| convert ctime(Created)
| table id Vulnerability Category "Solution Type" Severity "Detection Quality" IP Name Location Created</query>
          <earliest>$timeToken.earliest$</earliest>
          <latest>$timeToken.latest$</latest>
        </search>
        <option name="drilldown">none</option>
        <option name="refresh.display">progressbar</option>
      </table>
    </panel>
  </row>
</form>